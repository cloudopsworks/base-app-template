name: Delivery Push to Evironment Repo

on:
  workflow_call:
    inputs:
      release_version:
        required: true
        type: string
      release_name:
        required: false
        type: string
      environment:
        required: true
        type: string
    secrets:
      token:
        required: true

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      # Get the owner repo
      - name: Get owner
        id: getowner
        run: |
          repo_owner=`echo "$GITHUB_REPOSITORY" | cut -f 1 -d "/"`
          repo_name=`echo "$GITHUB_REPOSITORY" | cut -f 2 -d "/"`
          echo "owner=$repo_owner" >> $GITHUB_OUTPUT
          echo "repo_name=$repo_name" >> $GITHUB_OUTPUT

      # Build Payload script
      - name: Build Payload params
        id: params
        run: |
          repo="${{ steps.getowner.outputs.repo_name }}"
          release_name=$repo
          rn_in="${{ inputs.release_name }}"
          if [[ "$rn_in" != "" ]] ; then
            release_name="$rn_in"
          fi
          
          payload="{\"promote\": {"
          payload="${payload}\"repositoryowner\": \"${{ steps.getowner.outputs.owner }}\""
          payload="${payload}, \"repository\": \"${repo}\""
          payload="${payload}, \"environment\": \"${{ inputs.environment }}\""
          payload="${payload}, \"version\": \"${{ inputs.release_version }}\""
          payload="${payload}, \"releasename\": \"${release_name}\""
          payload="${payload} } }"

          echo "::set-output name=payload::$payload"

      # Send event to repository to launch new promotion
      - name: Send Event to Environment Repository
        id: send_event
        uses: peter-evans/repository-dispatch@v2
        with:
          token: "${{ secrets.token }}"
          repository: ${{ steps.getowner.outputs.owner }}/environment-${{ steps.getowner.outputs.owner }}-${{ inputs.environment }}
          event-type: promote-environment
          client-payload: '${{ steps.params.outputs.payload }}'

